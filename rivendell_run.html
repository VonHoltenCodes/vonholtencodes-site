<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight of the Great Eagle: Rivendell Run</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser.min.js"></script>
    <style>
        :root {
            --primary-color: #ff4500;
            --accent-color: #00ff00;
            --bg-color: #111111;
            --bg-secondary: #222222;
            --text-color: #ff4500;
            --highlight-color: #ffd700;
            --shadow-color: rgba(255, 69, 0, 0.7);
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-image: radial-gradient(circle, #171717 1px, transparent 1px);
            background-size: 15px 15px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' stroke='%23ff4500' stroke-width='2' fill='none'/%3E%3Ccircle cx='12' cy='12' r='2' fill='%23ff4500'/%3E%3Cline x1='12' y1='2' x2='12' y2='4' stroke='%23ff4500' stroke-width='2'/%3E%3Cline x1='12' y1='20' x2='12' y2='22' stroke='%23ff4500' stroke-width='2'/%3E%3Cline x1='2' y1='12' x2='4' y2='12' stroke='%23ff4500' stroke-width='2'/%3E%3Cline x1='20' y1='12' x2='22' y2='12' stroke='%23ff4500' stroke-width='2'/%3E%3C/svg%3E"), auto;
        }

        .night-mode {
            --primary-color: #00ff00;
            --accent-color: #00ff00;
            --text-color: #00ff00;
            --shadow-color: rgba(0, 255, 0, 0.7);
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' stroke='%2300ff00' stroke-width='2' fill='none'/%3E%3Ccircle cx='12' cy='12' r='2' fill='%2300ff00'/%3E%3Cline x1='12' y1='2' x2='12' y2='4' stroke='%2300ff00' stroke-width='2'/%3E%3Cline x1='12' y1='20' x2='12' y2='22' stroke='%2300ff00' stroke-width='2'/%3E%3Cline x1='2' y1='12' x2='4' y2='12' stroke='%2300ff00' stroke-width='2'/%3E%3Cline x1='20' y1='12' x2='22' y2='12' stroke='%2300ff00' stroke-width='2'/%3E%3C/svg%3E"), auto;
        }

        /* Header with Animation */
        header {
            position: relative;
            height: 120px;
            border-bottom: 2px solid var(--primary-color);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--shadow-color);
            margin-bottom: 10px;
        }
        
        .main-nav {
            margin-top: 10px;
        }
        
        .home-button {
            display: inline-flex;
            align-items: center;
            background-color: var(--bg-secondary);
            color: var(--text-color);
            text-decoration: none;
            padding: 8px 15px;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            gap: 8px;
        }
        
        .home-button:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
            box-shadow: 0 0 10px var(--shadow-color);
            transform: translateY(-2px);
        }
        
        .home-icon {
            font-size: 18px;
        }

        /* Night mode toggle button */
        .night-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-color);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            cursor: pointer;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }
        
        .night-mode-toggle:hover {
            text-decoration: underline;
        }

        /* Game Container */
        .game-container {
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-description {
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.6;
            max-width: 600px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .game-description::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
        }

        .game-description p {
            margin: 10px 0;
        }

        .backstory {
            font-style: italic;
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Game Mode Selection */
        .difficulty-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .difficulty-button {
            background-color: var(--bg-secondary);
            color: var(--text-color);
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            text-transform: uppercase;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 180px;
        }

        .difficulty-button:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--shadow-color);
            transform: translateY(-3px);
        }

        .difficulty-button .icon {
            font-size: 24px;
        }

        .difficulty-button .description {
            font-size: 12px;
            opacity: 0.8;
            font-weight: normal;
        }

        /* Game Canvas */
        #game-container {
            width: 100%;
            max-width: 800px;
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            overflow: hidden;
            display: none;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Controls Description */
        .controls-hint {
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            border: 1px dashed var(--primary-color);
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.2);
            display: none;
        }

        .controls-hint kbd {
            background-color: var(--bg-secondary);
            border: 1px solid var(--primary-color);
            border-radius: 3px;
            padding: 2px 5px;
            margin: 0 3px;
        }

        /* Loading Screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
        }

        .loading-text {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--shadow-color);
        }

        .progress-bar {
            width: 70%;
            height: 20px;
            background-color: var(--bg-secondary);
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Game Over Screen */
        .game-over-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            display: none;
            width: 80%;
            max-width: 400px;
            z-index: 100;
        }

        .game-over-panel h2 {
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--highlight-color);
        }

        .lotr-quote {
            font-style: italic;
            margin: 15px 0;
            font-size: 14px;
            opacity: 0.9;
            padding: 10px;
            border-left: 2px solid var(--primary-color);
        }

        .restart-button {
            background-color: var(--bg-secondary);
            color: var(--text-color);
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .restart-button:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        /* High Score Display */
        .high-scores {
            margin-top: 30px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            display: none;
        }

        .high-scores h3 {
            margin-top: 0;
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .score-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .score-list li {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted rgba(255, 69, 0, 0.3);
        }

        .score-list li:last-child {
            border-bottom: none;
        }

        .score-list .rank {
            font-weight: bold;
            color: var(--highlight-color);
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(255, 69, 0, 0.3);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 22px;
            }
            
            .difficulty-button {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 160px;
            }
            
            .game-description {
                font-size: 14px;
            }
            
            .game-container {
                padding: 15px;
            }
            
            .night-mode-toggle {
                top: 15px;
                right: 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="night-mode-toggle" onclick="toggleNightMode()">
        <span id="mode-text">NIGHT MODE</span>
    </button>

    <header>
        <div class="header-content">
            <h1>Flight of the Great Eagle: Rivendell Run</h1>
            <nav class="main-nav">
                <a href="index.html" class="home-button">
                    <span class="home-icon">‚åÇ</span>
                    RETURN TO BASE
                </a>
            </nav>
        </div>
    </header>

    <div class="game-container">
        <div class="game-description">
            <p class="backstory">"The Eagles are coming! The Eagles are coming!" - Bilbo Baggins</p>
            <p>Command Gwaihir the Windlord, mightiest of the Great Eagles, as you navigate the perilous skies above Rivendell.</p>
            <p>Dodge storm clouds, enemy bats, and orcish arrows while collecting starlight to maintain your energy!</p>
        </div>

        <div class="difficulty-selection" id="difficulty-selection">
            <button class="difficulty-button" onclick="startGame('easy')">
                <span class="icon">ü¶Ö</span>
                NOVICE FLIGHT
                <span class="description">For young eagles learning to soar</span>
            </button>
            <button class="difficulty-button" onclick="startGame('medium')">
                <span class="icon">‚öîÔ∏è</span>
                WARRIOR FLIGHT
                <span class="description">For battle-hardened eagles</span>
            </button>
            <button class="difficulty-button" onclick="startGame('hard')">
                <span class="icon">üíÄ</span>
                WINDLORD FLIGHT
                <span class="description">As challenging as Mount Doom itself</span>
            </button>
        </div>

        <div id="game-container">
            <div class="loading-screen" id="loading-screen">
                <div class="loading-text">Preparing for Flight...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            <div class="game-over-panel" id="game-over-panel">
                <h2 id="game-over-title">Journey's End</h2>
                <div class="score-display" id="final-score">Score: 0</div>
                <div class="lotr-quote" id="lotr-quote">The world is indeed full of peril...</div>
                <button class="restart-button" onclick="restartGame()">Fly Again</button>
            </div>
        </div>

        <div class="controls-hint" id="controls-hint">
            <p>Click or tap anywhere on the game to flap wings</p>
            <p>Try to collect golden starlight for energy!</p>
        </div>

        <div class="high-scores" id="high-scores">
            <h3>LEGENDARY FLIGHTS</h3>
            <ul class="score-list" id="score-list">
                <!-- High scores will be populated here -->
            </ul>
        </div>
    </div>

    <footer>
        VonHoltenCodes - Flight of the Great Eagle &copy; 2025
    </footer>

    <script>
        // Night mode toggle
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            updateModeText();
            
            // Store night mode preference
            localStorage.setItem('rivendellNightMode', document.body.classList.contains('night-mode'));
        }
        
        function updateModeText() {
            const modeText = document.getElementById('mode-text');
            if (document.body.classList.contains('night-mode')) {
                modeText.textContent = 'DAY MODE';
            } else {
                modeText.textContent = 'NIGHT MODE';
            }
        }
        
        // Check for night mode preference on load
        document.addEventListener('DOMContentLoaded', () => {
            const isNightMode = localStorage.getItem('rivendellNightMode') === 'true';
            if (isNightMode) {
                document.body.classList.add('night-mode');
            }
            updateModeText();
            
            // Prevent spacebar and arrow keys from scrolling the page
            window.addEventListener('keydown', function(e) {
                if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1 && e.target === document.body) {
                    e.preventDefault();
                }
            });
        });

        // High scores management
        const HIGH_SCORES_KEY = 'rivendellHighScores';
        
        function getHighScores() {
            const scores = localStorage.getItem(HIGH_SCORES_KEY);
            return scores ? JSON.parse(scores) : [];
        }
        
        function saveHighScore(difficulty, score) {
            const highScores = getHighScores();
            
            highScores.push({
                difficulty,
                score: Math.floor(score),
                date: new Date().toISOString()
            });
            
            // Sort by score (descending)
            highScores.sort((a, b) => b.score - a.score);
            
            // Keep only top 10
            const topScores = highScores.slice(0, 10);
            
            localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(topScores));
            
            return topScores;
        }
        
        function displayHighScores() {
            const highScores = getHighScores();
            const scoreList = document.getElementById('score-list');
            
            if (highScores.length === 0) {
                scoreList.innerHTML = '<li>No legendary flights recorded yet</li>';
                return;
            }
            
            scoreList.innerHTML = '';
            
            highScores.forEach((score, index) => {
                const li = document.createElement('li');
                const difficultyEmoji = score.difficulty === 'easy' ? 'ü¶Ö' : 
                                         score.difficulty === 'medium' ? '‚öîÔ∏è' : 'üíÄ';
                
                li.innerHTML = `
                    <span class="rank">${index + 1}. ${difficultyEmoji}</span>
                    <span class="score">${score.score} pts</span>
                `;
                
                scoreList.appendChild(li);
            });
            
            document.getElementById('high-scores').style.display = 'block';
        }

        // Game Variables
        let game, eagle, obstacles, powerUps, stars, mountains, trees;
        let scoreText, energyText, altitudeText, difficultyText;
        let score = 0, energy = 100, flightDistance = 0;
        let gameActive = false;
        let currentDifficulty = 'easy';
        let pauseKey, lotrQuotes;

        // Configuration based on difficulty
        const difficultySettings = {
            easy: {
                spawnRate: 3000,
                energyDepletion: 0.03,
                obstacleSpeed: 3,
                obstacleCount: 1,
                hitboxScale: 0.7,
                powerUpFrequency: 5000,
                powerUpValue: 20,
                eagleGravity: 300,
                eagleFlap: -250
            },
            medium: {
                spawnRate: 2000,
                energyDepletion: 0.05,
                obstacleSpeed: 4,
                obstacleCount: 1.5,
                hitboxScale: 0.8,
                powerUpFrequency: 6000,
                powerUpValue: 15,
                eagleGravity: 350,
                eagleFlap: -280
            },
            hard: {
                spawnRate: 1500,
                energyDepletion: 0.08,
                obstacleSpeed: 5,
                obstacleCount: 2,
                hitboxScale: 0.9,
                powerUpFrequency: 8000,
                powerUpValue: 10,
                eagleGravity: 400,
                eagleFlap: -320
            }
        };

        function showLoadingScreen() {
            document.getElementById('loading-screen').style.display = 'flex';
            const progressFill = document.getElementById('progress-fill');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += 2; // Slower progress
                progressFill.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                    }, 200);
                }
            }, 50);
        }

        function startGame(difficulty) {
            if (gameActive) return;
            
            currentDifficulty = difficulty;
            document.getElementById('difficulty-selection').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('controls-hint').style.display = 'block';
            
            showLoadingScreen();
            
            // LotR quotes for game over messages
            lotrQuotes = [
                "Not all those who wander are lost.",
                "Even the smallest person can change the course of the future.",
                "The world is indeed full of peril, and in it there are many dark places.",
                "Faithless is he that says farewell when the road darkens.",
                "All we have to decide is what to do with the time that is given us.",
                "Fly, you fools!",
                "There is some good in this world, and it's worth fighting for.",
                "Courage will now be your best defence against the storm that is at hand.",
                "The eagles are coming!",
                "It's a dangerous business, going out your door."
            ];
            
            // Wait a moment before initializing Phaser to ensure DOM has been updated
            setTimeout(() => {
                const config = {
                    type: Phaser.CANVAS,
                    width: 800,
                    height: 450,
                    parent: 'game-container',
                    backgroundColor: '#000044',
                    physics: {
                        default: 'arcade',
                        arcade: { 
                            gravity: { y: difficultySettings[difficulty].eagleGravity },
                            debug: false
                        }
                    },
                    scene: {
                        preload: preload,
                        create: create,
                        update: update
                    },
                    pixelArt: true,
                    audio: {
                        noAudio: true
                    }
                };
                
                try {
                    game = new Phaser.Game(config);
                    gameActive = true;
                } catch (error) {
                    console.error("Error initializing game:", error);
                    alert("Error initializing game. Please try refreshing the page.");
                }
            }, 100);
        }

        function preload() {
            // Set a background color for the loading phase
            this.cameras.main.setBackgroundColor('#000044');
            
            try {
                // Create graphics programmatically instead of loading from external sources
                
                // Create a simple colored rectangle for the eagle
                const eagleCanvas = document.createElement('canvas');
                eagleCanvas.width = 64;
                eagleCanvas.height = 64;
                const eagleCtx = eagleCanvas.getContext('2d');
                
                // Draw eagle body (brown rectangle)
                eagleCtx.fillStyle = '#6b3600';
                eagleCtx.fillRect(16, 16, 32, 32);
                
                // Draw eagle head (lighter color)
                eagleCtx.fillStyle = '#f7e7ce';
                eagleCtx.fillRect(38, 12, 10, 10);
                
                // Draw eagle wings (darker brown)
                eagleCtx.fillStyle = '#3b2106';
                eagleCtx.fillRect(8, 24, 48, 12);
                
                // Add the texture to the game
                this.textures.addCanvas('eagle', eagleCanvas);
                
                // Create a simple colored rectangle for the cloud
                const cloudCanvas = document.createElement('canvas');
                cloudCanvas.width = 64;
                cloudCanvas.height = 64;
                const cloudCtx = cloudCanvas.getContext('2d');
                
                // Draw cloud (gray rectangle)
                cloudCtx.fillStyle = '#888888';
                cloudCtx.fillRect(12, 20, 40, 24);
                
                // Draw cloud detail (darker gray)
                cloudCtx.fillStyle = '#666666';
                cloudCtx.fillRect(8, 28, 48, 12);
                
                // Add the texture to the game
                this.textures.addCanvas('cloud', cloudCanvas);
                
                // Create a simple colored rectangle for the bat
                const batCanvas = document.createElement('canvas');
                batCanvas.width = 32;
                batCanvas.height = 32;
                const batCtx = batCanvas.getContext('2d');
                
                // Draw bat body (dark rectangle)
                batCtx.fillStyle = '#222222';
                batCtx.fillRect(8, 8, 16, 8);
                batCtx.fillRect(4, 4, 24, 4);
                
                // Add the texture to the game
                this.textures.addCanvas('bat', batCanvas);
                
                // Create a simple colored rectangle for the arrow
                const arrowCanvas = document.createElement('canvas');
                arrowCanvas.width = 32;
                arrowCanvas.height = 16;
                const arrowCtx = arrowCanvas.getContext('2d');
                
                // Draw arrow shaft (brown rectangle)
                arrowCtx.fillStyle = '#8b4513';
                arrowCtx.fillRect(4, 6, 24, 4);
                
                // Draw arrow tip (gray rectangle)
                arrowCtx.fillStyle = '#666666';
                arrowCtx.fillRect(24, 3, 8, 10);
                
                // Add the texture to the game
                this.textures.addCanvas('arrow', arrowCanvas);
                
                // Create a simple colored rectangle for the starlight
                const starlightCanvas = document.createElement('canvas');
                starlightCanvas.width = 32;
                starlightCanvas.height = 32;
                const starlightCtx = starlightCanvas.getContext('2d');
                
                // Draw starlight (gold rectangle)
                starlightCtx.fillStyle = '#ffdf00';
                starlightCtx.fillRect(8, 8, 16, 16);
                starlightCtx.fillRect(12, 12, 8, 8);
                
                // Add the texture to the game
                this.textures.addCanvas('starlight', starlightCanvas);
                
                // Create a simple explosion circle
                const explosionCanvas = document.createElement('canvas');
                explosionCanvas.width = 64;
                explosionCanvas.height = 64;
                const explosionCtx = explosionCanvas.getContext('2d');
                
                // Draw outer circle (orange-red)
                explosionCtx.fillStyle = '#ff4500';
                explosionCtx.beginPath();
                explosionCtx.arc(32, 32, 24, 0, Math.PI * 2);
                explosionCtx.fill();
                
                // Draw inner circle (yellow)
                explosionCtx.fillStyle = '#ffff00';
                explosionCtx.beginPath();
                explosionCtx.arc(32, 32, 16, 0, Math.PI * 2);
                explosionCtx.fill();
                
                // Add the texture to the game
                this.textures.addCanvas('explosion', explosionCanvas);
                
                // Create a simple sky background
                const skyCanvas = document.createElement('canvas');
                skyCanvas.width = 800;
                skyCanvas.height = 450;
                const skyCtx = skyCanvas.getContext('2d');
                
                // Create gradient
                const skyGradient = skyCtx.createLinearGradient(0, 0, 0, 450);
                skyGradient.addColorStop(0, '#000044');
                skyGradient.addColorStop(1, '#0066aa');
                
                // Fill with gradient
                skyCtx.fillStyle = skyGradient;
                skyCtx.fillRect(0, 0, 800, 450);
                
                // Add the texture to the game
                this.textures.addCanvas('sky', skyCanvas);
                
                // Create a starry background
                const starsCanvas = document.createElement('canvas');
                starsCanvas.width = 800;
                starsCanvas.height = 450;
                const starsCtx = starsCanvas.getContext('2d');
                
                // Fill dark background
                starsCtx.fillStyle = '#000022';
                starsCtx.fillRect(0, 0, 800, 450);
                
                // Add stars
                starsCtx.fillStyle = '#ffffff';
                for (let i = 0; i < 100; i++) {
                    const x = Math.random() * 800;
                    const y = Math.random() * 400;
                    const size = Math.random() * 2 + 1;
                    starsCtx.beginPath();
                    starsCtx.arc(x, y, size, 0, Math.PI * 2);
                    starsCtx.fill();
                }
                
                // Add the texture to the game
                this.textures.addCanvas('stars', starsCanvas);
                
                // Create mountain background
                const mountainsCanvas = document.createElement('canvas');
                mountainsCanvas.width = 800;
                mountainsCanvas.height = 450;
                const mountainsCtx = mountainsCanvas.getContext('2d');
                
                // Draw mountains
                mountainsCtx.fillStyle = '#333344';
                mountainsCtx.beginPath();
                mountainsCtx.moveTo(0, 450);
                mountainsCtx.lineTo(0, 350);
                mountainsCtx.lineTo(100, 250);
                mountainsCtx.lineTo(200, 350);
                mountainsCtx.lineTo(300, 200);
                mountainsCtx.lineTo(400, 300);
                mountainsCtx.lineTo(500, 200);
                mountainsCtx.lineTo(600, 350);
                mountainsCtx.lineTo(700, 300);
                mountainsCtx.lineTo(800, 350);
                mountainsCtx.lineTo(800, 450);
                mountainsCtx.closePath();
                mountainsCtx.fill();
                
                // Add the texture to the game
                this.textures.addCanvas('mountains', mountainsCanvas);
                
                // Create tree background
                const treesCanvas = document.createElement('canvas');
                treesCanvas.width = 800;
                treesCanvas.height = 450;
                const treesCtx = treesCanvas.getContext('2d');
                
                // Draw a forest line
                treesCtx.fillStyle = '#005500';
                for (let x = 0; x < 800; x += 30) {
                    const height = 20 + Math.random() * 30;
                    
                    // Tree trunk
                    treesCtx.fillRect(x, 450 - height, 20, height);
                    
                    // Tree top (triangle)
                    treesCtx.beginPath();
                    treesCtx.moveTo(x - 10, 450 - height);
                    treesCtx.lineTo(x + 30, 450 - height);
                    treesCtx.lineTo(x + 10, 450 - height - 30);
                    treesCtx.fill();
                }
                
                // Add the texture to the game
                this.textures.addCanvas('trees', treesCanvas);
                
                // Use empty audio since we can't load external files
                this.load.audio('flap', 'data:audio/wav;base64,UklGRl9vT19TAEFWRVdhdmUAAAAAAAAAAAAA');
                this.load.audio('chime', 'data:audio/wav;base64,UklGRl9vT19TAEFWRVdhdmUAAAAAAAAAAAAA');
                this.load.audio('crash', 'data:audio/wav;base64,UklGRl9vT19TAEFWRVdhdmUAAAAAAAAAAAAA');
                this.load.audio('background', 'data:audio/wav;base64,UklGRl9vT19TAEFWRVdhdmUAAAAAAAAAAAAA');
                this.load.audio('powerup', 'data:audio/wav;base64,UklGRl9vT19TAEFWRVdhdmUAAAAAAAAAAAAA');
            } catch (error) {
                console.error("Error in preload:", error);
            }
        }

        function create() {
            try {
                // Reset game variables
                score = 0;
                energy = 100;
                flightDistance = 0;
                
                // Parallax background - ensure this is rendered first
                this.add.image(400, 225, 'sky').setScrollFactor(0);
                stars = this.add.tileSprite(400, 225, 800, 450, 'stars').setScrollFactor(0);
                
                mountains = this.add.tileSprite(400, 225, 800, 450, 'mountains').setScrollFactor(0);
                trees = this.add.tileSprite(400, 225, 800, 450, 'trees').setScrollFactor(0);
                
                // We don't need animations since we're using static sprites
                // But we'll create simple placeholder animations to avoid errors
                
                const animKeys = [
                    { key: 'eagle-flap', texture: 'eagle' },
                    { key: 'eagle-glide', texture: 'eagle' },
                    { key: 'cloud-flicker', texture: 'cloud' },
                    { key: 'bat-flap', texture: 'bat' },
                    { key: 'arrow-spin', texture: 'arrow' },
                    { key: 'starlight-pulse', texture: 'starlight' },
                    { key: 'explosion-blast', texture: 'explosion' }
                ];
                
                // Create a simple animation for each sprite
                animKeys.forEach(anim => {
                    this.anims.create({
                        key: anim.key,
                        frames: [ { key: anim.texture } ],
                        frameRate: 5,
                        repeat: anim.key === 'explosion-blast' ? 0 : -1
                    });
                });
                
                // Eagle
                eagle = this.physics.add.sprite(150, 225, 'eagle')
                    .setCollideWorldBounds(true)
                    .setScale(1.5)
                    .play('eagle-flap');
                    
                // Reduce hitbox size for more forgiving gameplay
                eagle.body.setSize(
                    64 * difficultySettings[currentDifficulty].hitboxScale, 
                    64 * difficultySettings[currentDifficulty].hitboxScale
                );
                
                // Groups
                obstacles = this.physics.add.group();
                powerUps = this.physics.add.group();
                
                // Spawn obstacles
                this.time.addEvent({
                    delay: difficultySettings[currentDifficulty].spawnRate,
                    callback: spawnObstacle,
                    callbackScope: this,
                    loop: true
                });
                
                // Spawn power-ups
                this.time.addEvent({
                    delay: difficultySettings[currentDifficulty].powerUpFrequency,
                    callback: spawnPowerUp,
                    callbackScope: this,
                    loop: true
                });
                
                // UI Elements with enhanced styling
                const textStyle = {
                    fontFamily: '"Courier New", monospace',
                    fontSize: '14px',
                    color: '#ffd700',
                    stroke: '#000000',
                    strokeThickness: 3,
                    shadow: { offsetX: 2, offsetY: 2, color: '#000', blur: 5, fill: true }
                };
                
                scoreText = this.add.text(20, 20, 'SCORE: 0', textStyle);
                energyText = this.add.text(20, 50, 'ENERGY: 100%', textStyle);
                altitudeText = this.add.text(20, 80, 'DISTANCE: 0', textStyle);
                
                const difficultyLabel = currentDifficulty === 'easy' ? 'NOVICE FLIGHT' : 
                                       currentDifficulty === 'medium' ? 'WARRIOR FLIGHT' : 'WINDLORD FLIGHT';
                
                difficultyText = this.add.text(650, 20, difficultyLabel, {
                    fontFamily: '"Courier New", monospace',
                    fontSize: '10px',
                    color: currentDifficulty === 'easy' ? '#00ff00' : currentDifficulty === 'medium' ? '#ffff00' : '#ff0000',
                    stroke: '#000000',
                    strokeThickness: 3
                });
                
                // Energy bar
                this.energyBarBg = this.add.rectangle(120, 65, 200, 10, 0x333333);
                this.energyBarFill = this.add.rectangle(120, 65, 200, 10, 0x00ff00);
                this.energyBarBg.setOrigin(0.5);
                this.energyBarFill.setOrigin(0, 0.5);
                this.energyBarFill.x = 20;
                
                // Input Handling - keyboard
                this.input.keyboard.on('keydown-SPACE', flap, this);
                this.input.keyboard.on('keydown-UP', flap, this);
                
                // Input Handling - touch/mobile
                this.input.on('pointerdown', flap, this);
                
                // Pause functionality
                pauseKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P);
                this.input.keyboard.on('keydown-P', () => {
                    if (this.scene.isPaused()) {
                        this.scene.resume();
                    } else {
                        this.scene.pause();
                        this.add.text(400, 225, 'PAUSED\nPress P to resume', {
                            fontFamily: '"Courier New", monospace',
                            fontSize: '24px',
                            color: '#ffffff',
                            align: 'center',
                            stroke: '#000000',
                            strokeThickness: 4
                        }).setOrigin(0.5).setScrollFactor(0).setDepth(100);
                    }
                });
                
                // Collisions
                this.physics.add.collider(eagle, obstacles, eagleHit, null, this);
                this.physics.add.overlap(eagle, powerUps, collectPowerUp, null, this);
                
                // Background music - silent but sets the stage for audio
                this.backgroundMusic = this.sound.add('background', { volume: 0.1, loop: true });
                this.backgroundMusic.play();
            } catch (error) {
                console.error("Error in create:", error);
            }
        }

        function update(time) {
            try {
                if (!gameActive) return;
                
                // Update score and distance
                score += 0.1;
                flightDistance += 0.2;
                scoreText.setText(`SCORE: ${Math.floor(score)}`);
                altitudeText.setText(`DISTANCE: ${Math.floor(flightDistance)} m`);
                
                // Update energy
                energy = Math.max(0, energy - difficultySettings[currentDifficulty].energyDepletion);
                energyText.setText(`ENERGY: ${Math.floor(energy)}%`);
                
                // Update energy bar
                this.energyBarFill.width = (energy / 100) * 200;
                this.energyBarFill.fillColor = energy > 50 ? 0x00ff00 : energy > 25 ? 0xffff00 : 0xff0000;
                
                // Check for energy depletion
                if (energy <= 0) {
                    endGame.call(this, 'Energy Depleted');
                    return;
                }
                
                // Update eagle animation based on velocity
                if (eagle.body.velocity.y < 0) {
                    eagle.play('eagle-flap', true);
                } else {
                    eagle.play('eagle-glide', true);
                }
                
                // Tilt eagle based on vertical velocity
                eagle.angle = Phaser.Math.Clamp(eagle.body.velocity.y * 0.05, -15, 15);
                
                // Update obstacles
                obstacles.children.iterate(child => {
                    if (child.texture.key === 'bat') {
                        child.x -= difficultySettings[currentDifficulty].obstacleSpeed + 1;
                        child.y += Math.sin(time / 200) * 2; // Oscillating motion
                    } else if (child.texture.key === 'arrow') {
                        child.x -= difficultySettings[currentDifficulty].obstacleSpeed + 2;
                    } else {
                        child.x -= difficultySettings[currentDifficulty].obstacleSpeed;
                    }
                    
                    if (child.x < -100) child.destroy();
                });
                
                // Update power-ups
                powerUps.children.iterate(child => {
                    child.x -= (difficultySettings[currentDifficulty].obstacleSpeed - 1);
                    if (child.x < -100) child.destroy();
                });
                
                // Parallax scrolling for background layers
                stars.tilePositionX += 0.2;
                mountains.tilePositionX += 0.5;
                trees.tilePositionX += 1;
            } catch (error) {
                console.error("Error in update:", error);
            }
        }

        function flap() {
            try {
                if (!gameActive) return;
                
                eagle.setVelocityY(difficultySettings[currentDifficulty].eagleFlap);
                this.sound.play('flap', { volume: 0.3 });
                
                // Energy consumption on flap
                energy -= 0.5;
            } catch (error) {
                console.error("Error in flap:", error);
            }
        }

        function spawnObstacle() {
            try {
                // Determine how many obstacles to spawn based on difficulty
                const count = Math.floor(difficultySettings[currentDifficulty].obstacleCount);
                const extraChance = difficultySettings[currentDifficulty].obstacleCount - count;
                
                // Spawn base count obstacles
                for (let i = 0; i < count; i++) {
                    createSingleObstacle.call(this);
                }
                
                // Chance for an extra obstacle
                if (Math.random() < extraChance) {
                    createSingleObstacle.call(this);
                }
            } catch (error) {
                console.error("Error in spawnObstacle:", error);
            }
        }
        
        function createSingleObstacle() {
            try {
                const y = Phaser.Math.Between(50, 400);
                const types = ['cloud', 'bat', 'arrow'];
                const weights = currentDifficulty === 'easy' ? [0.5, 0.3, 0.2] : 
                               currentDifficulty === 'medium' ? [0.4, 0.3, 0.3] : 
                               [0.3, 0.3, 0.4];
                
                const rand = Math.random();
                let typeIndex = 0;
                let sum = 0;
                
                for (let i = 0; i < weights.length; i++) {
                    sum += weights[i];
                    if (rand < sum) {
                        typeIndex = i;
                        break;
                    }
                }
                
                const type = types[typeIndex];
                const scale = type === 'cloud' ? 1.2 : type === 'bat' ? 1.5 : 1.5;
                
                const obstacle = obstacles.create(850, y, type)
                    .setScale(scale);
                    
                // Custom hitbox sizes for more precision
                const hitboxScale = difficultySettings[currentDifficulty].hitboxScale;
                obstacle.body.setSize(
                    (type === 'cloud' ? 64 : type === 'bat' ? 24 : 28) * hitboxScale,
                    (type === 'cloud' ? 48 : type === 'bat' ? 16 : 8) * hitboxScale
                );
                
                if (type === 'cloud') obstacle.play('cloud-flicker');
                if (type === 'bat') obstacle.play('bat-flap');
                if (type === 'arrow') obstacle.play('arrow-spin');
                
                // Visual effect for arrows - they're shot from the right with a burst
                if (type === 'arrow') {
                    obstacle.setVelocityX(-150);
                    
                    // Arrow trail effect
                    this.time.addEvent({
                        delay: 100,
                        repeat: 5,
                        callback: () => {
                            if (obstacle.active) {
                                const trail = this.add.rectangle(
                                    obstacle.x + Phaser.Math.Between(-5, 5), 
                                    obstacle.y + Phaser.Math.Between(-5, 5), 
                                    10, 5, 0xaaaaaa
                                ).setAlpha(0.5);
                                
                                this.tweens.add({
                                    targets: trail,
                                    alpha: 0,
                                    duration: 300,
                                    onComplete: () => trail.destroy()
                                });
                            }
                        }
                    });
                }
            } catch (error) {
                console.error("Error in createSingleObstacle:", error);
            }
        }

        function spawnPowerUp() {
            try {
                const y = Phaser.Math.Between(50, 400);
                const powerUp = powerUps.create(850, y, 'starlight')
                    .setScale(1.5)
                    .play('starlight-pulse');
                    
                // Set smaller hitbox for better precision
                powerUp.body.setSize(24, 24);
                
                // Add floating movement animation
                this.tweens.add({
                    targets: powerUp,
                    y: y + 20,
                    duration: 1000,
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut'
                });
            } catch (error) {
                console.error("Error in spawnPowerUp:", error);
            }
        }

        function collectPowerUp(eagle, powerUp) {
            try {
                powerUp.destroy();
                
                // Energy gain plus visual feedback
                const energyGain = difficultySettings[currentDifficulty].powerUpValue;
                energy = Math.min(100, energy + energyGain);
                
                // Score bonus
                score += 25;
                
                // Sound effect
                this.sound.play('powerup', { volume: 0.5 });
                
                // Visual effects - starlight burst
                const burst = this.add.sprite(eagle.x, eagle.y, 'explosion')
                    .setScale(1.5)
                    .setTint(0xffff00)
                    .setAlpha(0.7)
                    .play('explosion-blast');
                    
                burst.on('animationcomplete', () => {
                    burst.destroy();
                });
                
                // Message with LotR reference
                const messages = [
                    "Soar high, Gwaihir!",
                    "The might of Manw√´!",
                    "Swift as the West Wind!",
                    "Strength returns!",
                    "Rivendell watches over you!"
                ];
                
                const message = this.add.text(
                    eagle.x, 
                    eagle.y - 50, 
                    messages[Phaser.Math.Between(0, messages.length - 1)], 
                    {
                        fontFamily: '"Courier New", monospace',
                        fontSize: '12px',
                        color: '#ffff00',
                        stroke: '#000000',
                        strokeThickness: 3
                    }
                ).setOrigin(0.5);
                
                this.tweens.add({
                    targets: message,
                    y: message.y - 30,
                    alpha: 0,
                    duration: 1500,
                    onComplete: () => message.destroy()
                });
            } catch (error) {
                console.error("Error in collectPowerUp:", error);
            }
        }

        function eagleHit(eagle, obstacle) {
            try {
                // First hit just damages the eagle if on easy mode - second chance
                if (currentDifficulty === 'easy' && energy > 50) {
                    obstacle.destroy();
                    energy -= 30;
                    this.cameras.main.shake(200, 0.01);
                    
                    // Hit effect
                    eagle.setTint(0xff0000);
                    this.time.delayedCall(200, () => {
                        eagle.clearTint();
                    });
                    
                    // Sound
                    this.sound.play('crash', { volume: 0.3 });
                    
                    return;
                }
                
                endGame.call(this, 'Eagle Down');
            } catch (error) {
                console.error("Error in eagleHit:", error);
            }
        }

        function endGame(reason) {
            try {
                gameActive = false;
                
                // Stop physics and background music
                this.physics.pause();
                if (this.backgroundMusic) {
                    this.backgroundMusic.stop();
                }
                
                // Visual effect - explosion
                const explosion = this.add.sprite(eagle.x, eagle.y, 'explosion')
                    .setScale(2)
                    .play('explosion-blast');
                    
                explosion.on('animationcomplete', () => {
                    // Hide the eagle
                    eagle.setVisible(false);
                    
                    // Show game over panel
                    const gameOverPanel = document.getElementById('game-over-panel');
                    gameOverPanel.style.display = 'block';
                    
                    // Set panel content
                    document.getElementById('game-over-title').textContent = reason;
                    document.getElementById('final-score').textContent = `Score: ${Math.floor(score)}`;
                    document.getElementById('lotr-quote').textContent = lotrQuotes[Phaser.Math.Between(0, lotrQuotes.length - 1)];
                    
                    // Save high score
                    saveHighScore(currentDifficulty, score);
                    displayHighScores();
                });
            } catch (error) {
                console.error("Error in endGame:", error);
            }
        }

        function restartGame() {
            try {
                // Hide game over panel
                document.getElementById('game-over-panel').style.display = 'none';
                
                // Clean up old game instance
                if (game) {
                    game.destroy(true);
                }
                
                // Show difficulty selection again
                document.getElementById('difficulty-selection').style.display = 'flex';
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('controls-hint').style.display = 'none';
                document.getElementById('high-scores').style.display = 'none';
                
                gameActive = false;
            } catch (error) {
                console.error("Error in restartGame:", error);
            }
        }
    </script>
</body>
</html>